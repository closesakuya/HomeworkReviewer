{"version":3,"file":"login.js","sources":["pages/login.vue","../../../../../TOOL/TOOL/HBuilderX.4.76.2025082103/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbG9naW4udnVl"],"sourcesContent":["<template>\n\t<view class=\"login-container\">\n\t\t<image class=\"logo\" src=\"/static/logo.png\"></image>\n\t\t<text class=\"title\">欢迎使用作业评价系统</text>\n\n\t\t<button v-if=\"loginState === 'initial'\" class=\"login-btn\" @click=\"handleLogin\">微信一键登录</button>\n\n\t\t<view v-if=\"loginState === 'profileRequired'\" class=\"profile-section\">\n\t\t\t<picker @change=\"bindPickerChange\" :value=\"schoolIndex\" :range=\"schools\" range-key=\"name\">\n\t\t\t\t<view class=\"school-picker\">\n\t\t\t\t\t<text>选择学校：</text>\n\t\t\t\t\t<text class=\"school-name\">{{schools[schoolIndex] ? schools[schoolIndex].name : '请选择'}}</text>\n\t\t\t\t</view>\n\t\t\t</picker>\n\t\t\t<button class=\"login-btn\" open-type=\"getUserInfo\" @click=\"handleGetUserProfile\">\n\t\t\t\t授权并完成注册\n\t\t\t</button>\n\t\t</view>\n\n\t\t<text class=\"tips\">登录即表示同意用户协议和隐私政策</text>\n\t</view>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue';\nimport { useUserStore } from '../store/user.js';\n// 确保导入了我们重构后的 API\nimport { loginByWeixinApi, getUserInfoApi, updateUserApi } from '../api/user.js';\nimport { getSchoolsApi } from '../api/data.js';\n\nconst userStore = useUserStore();\nconst loginState = ref('initial');\nconst schools = ref([]);\nconst schoolIndex = ref(0);\nlet selectedSchoolId = null;\n\nonMounted(async () => {\n\tconsole.log('[Login Page] onMounted: 组件已挂载，开始获取学校列表...');\n\ttry {\n\t\tconst schoolList = await getSchoolsApi();\n\t\tschools.value = schoolList;\n\t\tif (schoolList.length > 0) {\n\t\t\tselectedSchoolId = schoolList[0]._id;\n\t\t\tconsole.log('[Login Page] onMounted: 学校列表获取成功，默认选中:', schools.value[0].name);\n\t\t}\n\t} catch (e) {\n\t\thandleError(e, '学校列表加载失败');\n\t}\n});\n\nfunction bindPickerChange(e) {\n\tschoolIndex.value = e.detail.value;\n\tselectedSchoolId = schools.value[schoolIndex.value]._id;\n\tconsole.log('[Login Page] bindPickerChange: 用户选择了学校:', schools.value[schoolIndex.value].name);\n}\n\n// 第一步：处理静默登录\nasync function handleLogin() {\n\tconsole.log('[Login Page] handleLogin: 用户点击登录...');\n\tuni.showLoading({ title: '登录中...' });\n\ttry {\n\t\tconsole.log('[Login Page] handleLogin: 步骤 1/3 - 调用 uni.login() 获取 code...');\n\t\tconst { code } = await uni.login({ provider: 'weixin' });\n\t\tconsole.log('[Login Page] handleLogin: 获取 code 成功:', code);\n\n\t\tconsole.log('[Login Page] handleLogin: 步骤 2/3 - 调用 loginByWeixinApi(code) 获取 token...');\n\t\tconst loginResult = await loginByWeixinApi(code);\n\t\tif (loginResult.errCode !== 0) throw new Error(loginResult.errMsg);\n\t\tconsole.log('[Login Page] handleLogin: 云端登录成功，返回结果:', loginResult);\n\t\t\n\t\t// 存储关键凭证\n\t\tuserStore.setToken(loginResult.newToken.token);\n\t\tuni.setStorageSync('uni_uid', loginResult.uid);\n\t\tconsole.log('[Login Page] handleLogin: Token 和 UID 已存入本地缓存');\n\n\t\tconsole.log('[Login Page] handleLogin: 步骤 3/3 - 调用 getUserInfoApi() 获取用户详细信息...');\n\t\tconst userInfoResult = await getUserInfoApi();\n\t\tif (userInfoResult.errCode !== 0) throw new Error(userInfoResult.errMsg);\n\t\tconst fullUserInfo = userInfoResult.userInfo;\n\t\tconsole.log('[Login Page] handleLogin: 成功获取到用户完整信息:', fullUserInfo);\n\n\t\tuni.hideLoading();\n\n\t\t// 【关键判断】用 nickname 字段判断是否是新用户\n\t\tif (!fullUserInfo.nickname) {\n\t\t\tconsole.log('[Login Page] handleLogin: 判断为新用户 (nickname 为空)，切换到授权界面');\n\t\t\tloginState.value = 'profileRequired';\n\t\t} else {\n\t\t\tconsole.log('[Login Page] handleLogin: 判断为老用户，直接登录');\n\t\t\tuserStore.setUserInfo(fullUserInfo);\n\t\t\tredirectUser(fullUserInfo.role);\n\t\t}\n\t} catch (error) {\n\t\thandleError(error, '登录失败');\n\t}\n}\n\n// 第二步：处理用户点击授权按钮\nasync function handleGetUserProfile() {\n\tconsole.log('[Login Page] handleGetUserProfile: 用户点击授权按钮...');\n\tif (!selectedSchoolId) {\n\t\tuni.showToast({ title: '请先选择学校', icon: 'none' });\n\t\treturn;\n\t}\n\tuni.showLoading({ title: '更新资料中...' });\n\ttry {\n\t\tconsole.log('[Login Page] handleGetUserProfile: 步骤 1/3 - 调用 uni.getUserProfile() 弹出授权框...');\n\t\tconst { userInfo } = await uni.getUserProfile({ desc: '用于完善会员资料' });\n\t\tconsole.log('[Login Page] handleGetUserProfile: 用户已授权，获取到微信资料:', userInfo);\n\t\t\n\t\tconst updateData = {\n\t\t\tnickname: userInfo.nickName,\n\t\t\tavatar: userInfo.avatarUrl,\n\t\t\tschool_id: selectedSchoolId\n\t\t};\n\t\tconsole.log('[Login Page] handleGetUserProfile: 步骤 2/3 - 调用 updateUserApi() 更新数据库，参数:', updateData);\n\t\tawait updateUserApi(updateData);\n\t\tconsole.log('[Login Page] handleGetUserProfile: 数据库更新成功');\n\t\t\n\t\tconsole.log('[Login Page] handleGetUserProfile: 步骤 3/3 - 重新获取最新的用户信息...');\n\t\tconst finalUserInfoResult = await getUserInfoApi();\n\t\tconst finalUserInfo = finalUserInfoResult.userInfo;\n\t\tconsole.log('[Login Page] handleGetUserProfile: 获取到最终用户信息:', finalUserInfo);\n\t\tuserStore.setUserInfo(finalUserInfo);\n\t\t\n\t\tuni.hideLoading();\n\t\tredirectUser(finalUserInfo.role);\n\n\t} catch (error) {\n\t\thandleError(error, '授权失败');\n\t}\n}\n\n// 根据用户角色跳转到不同页面\nfunction redirectUser(roles = []) {\n\tconsole.log('[Login Page] redirectUser: 准备跳转，接收到的角色列表:', roles);\n\tuni.showToast({ title: '登录成功', icon: 'success' });\n\tif (roles && roles.includes('principal')) {\n\t\tconsole.log('[Login Page] redirectUser: 检测到校长角色，跳转到校长中心');\n\t\tuni.reLaunch({ url: '/pages/principal/index' });\n\t} else if (roles && roles.includes('teacher')) {\n\t\tconsole.log('[Login Page] redirectUser: 检测到教师角色，跳转到教师中心');\n\t\tuni.reLaunch({ url: '/pages/teacher/index' });\n\t} else {\n\t\tconsole.log('[Login Page] redirectUser: 未检测到特殊角色，跳转到学生中心');\n\t\tuni.reLaunch({ url: '/pages/student/index' });\n\t}\n}\n\n// 统一的错误处理函数\nfunction handleError(error, title) {\n\tuni.hideLoading();\n\tconsole.error(`[${title}]`, error);\n\tuni.showModal({ title: title, content: error.message || '请稍后再试', showCancel: false });\n}\n</script>\n\n<style scoped>\n.login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; height: 100vh; box-sizing: border-box; }\n.logo { width: 100px; height: 100px; margin-bottom: 20px; }\n.title { font-size: 22px; color: #333; margin-bottom: 40px; }\n.profile-section { width: 100%; text-align: center; }\n.school-picker { width: 100%; height: 50px; line-height: 50px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0 15px; margin-bottom: 20px; box-sizing: border-box; display: flex; justify-content: space-between; }\n.school-name { color: #333; }\n.login-btn { width: 100%; background-color: #07c160; color: white; border-radius: 8px; font-size: 16px; margin-top: 10px; }\n.tips { margin-top: 20px; font-size: 12px; color: #999; }\n</style>","import MiniProgramPage from 'D:/share_dir/product_env/git_repo/HomeworkReviewer/HomeworkReviewer/pages/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","ref","onMounted","uni","getSchoolsApi","loginByWeixinApi","getUserInfoApi","updateUserApi"],"mappings":"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"}