{"version":3,"file":"user.js","sources":["api/user.js"],"sourcesContent":["// api/user.js\n\n// 导入 uni-id 官方云对象，用于处理登录等标准化操作\nconst uniIdCo = uniCloud.importObject('uni-id-co', { customUI: true });\n// 导入 clientDB 实例，这是客户端直接、安全操作数据库的核心\nconst db = uniCloud.database();\n\n/**\n * 调用官方云对象进行微信登录\n * @param {string} code - uni.login 获取到的 code\n * @returns {Promise<object>}\n */\nexport const loginByWeixinApi = async (code) => {\n\treturn await uniIdCo.loginByWeixin({ code });\n}\n\n/**\n * 【核心重构】使用 clientDB 获取当前登录用户的完整信息\n * @returns {Promise<object>}\n */\nexport const getUserInfoApi = async () => {\n\tconst uid = uni.getStorageSync('uni_uid');\n\tif (!uid) {\n\t\treturn { errCode: 'uni-id-token-expired', errMsg: '登录状态无效' }\n\t}\n\n\t// 【核心修正】将 .field() 的参数从对象改为用逗号分隔的字符串，避免别名冲突\n\tconst userRes = await db.collection('uni-id-users').doc(uid).field(\n\t\t'nickname, avatar, role, school_id'\n\t).get();\n\n\tif (userRes.result.data && userRes.result.data.length > 0) {\n\t\tconst userInfo = userRes.result.data[0];\n\t\treturn {\n\t\t\terrCode: 0,\n\t\t\terrMsg: '获取成功',\n\t\t\tuserInfo: userInfo\n\t\t}\n\t} else {\n\t\treturn { errCode: 'user-not-exist', errMsg: '用户不存在' }\n\t}\n}\n\n/**\n * 使用 clientDB 更新当前用户信息\n * @param {object} params - 需要更新的字段，如 { nickname, avatar, school_id }\n * @returns {Promise<object>}\n */\nexport const updateUserApi = async (params) => {\n\tconst uid = uni.getStorageSync('uni_uid');\n\tif (!uid) {\n\t\tthrow new Error('uid not found, please login again.');\n\t}\n\treturn await db.collection('uni-id-users').doc(uid).update(params);\n}"],"names":["uniCloud","uni"],"mappings":";;AAGA,MAAM,UAAUA,cAAQ,GAAC,aAAa,aAAa,EAAE,UAAU,KAAI,CAAE;AAErE,MAAM,KAAKA,cAAAA,GAAS;AAOR,MAAC,mBAAmB,OAAO,SAAS;AAC/C,SAAO,MAAM,QAAQ,cAAc,EAAE,KAAM,CAAA;AAC5C;AAMY,MAAC,iBAAiB,YAAY;AACzC,QAAM,MAAMC,cAAAA,MAAI,eAAe,SAAS;AACxC,MAAI,CAAC,KAAK;AACT,WAAO,EAAE,SAAS,wBAAwB,QAAQ,SAAU;AAAA,EAC5D;AAGD,QAAM,UAAU,MAAM,GAAG,WAAW,cAAc,EAAE,IAAI,GAAG,EAAE;AAAA,IAC5D;AAAA,EACA,EAAC,IAAG;AAEL,MAAI,QAAQ,OAAO,QAAQ,QAAQ,OAAO,KAAK,SAAS,GAAG;AAC1D,UAAM,WAAW,QAAQ,OAAO,KAAK,CAAC;AACtC,WAAO;AAAA,MACN,SAAS;AAAA,MACT,QAAQ;AAAA,MACR;AAAA,IACA;AAAA,EACH,OAAQ;AACN,WAAO,EAAE,SAAS,kBAAkB,QAAQ,QAAS;AAAA,EACrD;AACF;AAOY,MAAC,gBAAgB,OAAO,WAAW;AAC9C,QAAM,MAAMA,cAAAA,MAAI,eAAe,SAAS;AACxC,MAAI,CAAC,KAAK;AACT,UAAM,IAAI,MAAM,oCAAoC;AAAA,EACpD;AACD,SAAO,MAAM,GAAG,WAAW,cAAc,EAAE,IAAI,GAAG,EAAE,OAAO,MAAM;AAClE;;;;"}