"use strict";const e=require("../common/vendor.js"),i=require("../common/assets.js"),n=require("../api/user.js"),o=require("../store/user.js"),r={__name:"login",setup(r){const s=o.useUserStore(),a=e.ref("initial");async function t(){console.log("第一步：开始静默登录..."),e.index.showLoading({title:"登录中..."});try{const i=await e.index.login({provider:"weixin"});if("login:ok"!==i.errMsg)throw new Error("获取登录凭证失败");const o=i.code,r=await n.loginByWeixinApi(o);if(0!==r.errCode)throw new Error(r.errMsg);s.setToken(r.newToken.token);const t=await n.getUserInfoApi();if(0!==t.errCode)throw new Error(t.errMsg);e.index.hideLoading(),t.isNicknameSet?(s.setUserInfo(t),e.index.showToast({title:"登录成功",icon:"success"}),e.index.reLaunch({url:"/pages/student/index"})):(console.log("需要用户授权头像昵称"),a.value="profileRequired")}catch(i){e.index.hideLoading(),d(i,"登录失败")}}async function c(){console.log("第二步：用户点击授权按钮..."),e.index.showLoading({title:"正在更新资料..."});try{const i=(await e.index.getUserProfile({desc:"用于完善会员资料"})).userInfo;await n.updateUserApi({nickname:i.nickName,avatar:i.avatarUrl}),s.setUserInfo({nickname:i.nickName,avatar:i.avatarUrl}),e.index.hideLoading(),e.index.showToast({title:"授权成功",icon:"success"}),e.index.reLaunch({url:"/pages/student/index"})}catch(i){e.index.hideLoading(),i.errMsg&&i.errMsg.includes("fail auth deny")?d({message:"您已拒绝授权"},"操作提示"):d(i,"授权失败")}}function d(i,n){console.error(`${n}:`,i),e.index.showModal({title:n,content:i.message||"请稍后再试",showCancel:!1})}return e.onLoad((()=>{console.log("登录页面加载")})),(n,o)=>e.e({a:i._imports_0,b:"initial"===a.value},"initial"===a.value?{c:e.o(t)}:{},{d:"profileRequired"===a.value},"profileRequired"===a.value?{e:e.o(c)}:{})}},s=e._export_sfc(r,[["__scopeId","data-v-fd8181ba"]]);wx.createPage(s);
